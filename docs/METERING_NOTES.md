# METERING_NOTES — Harmonyk (PG-W1 Day 4)

Lightweight usage metering for the post-GA Harmonyk build.

Goal for PG-W1:

- Define a simple `metering_events` table.
- Provide a server-only logging helper (`logUsageEvent`).
- Expose an internal `/admin/metrics` view that aggregates the last 7 days
  of events by org + event type for sanity checks.

This is not billing-grade metering yet; that evolves in PG-W23.

---

## 1. Table shape (Supabase)

**Table:** `public.metering_events`

Recommended schema:

- `id uuid primary key default gen_random_uuid()`
- `org_id uuid not null`
- `user_id uuid null`
- `event_type text not null`
- `amount integer not null default 1`
- `metadata jsonb not null default '{}'::jsonb`
- `created_at timestamptz not null default now()`

Recommended indexes:

- `idx_metering_events_org_event_created_at` on `(org_id, event_type, created_at desc)`
- `idx_metering_events_created_at` on `(created_at desc)`

> Note: `pgcrypto` (for `gen_random_uuid()`) should already be enabled from
> other tables. If not, run:
>
> ```sql
> create extension if not exists "pgcrypto";
> ```

RLS:

- For now this table is assumed to be **org-scoped** and readable only by
  internal/admin routes. RLS policies can be added later when we start
  surfacing per-org usage in-app.

---

## 2. Event taxonomy (PG-W1)

`UsageEventType` (defined in `lib/metering.ts`):

- `"doc_created"` — a new doc is created (from scratch or import).
- `"doc_saved"` — an existing doc is saved/updated into Vault.
- `"contract_generated"` — a contract is generated by Maestro/Builder.
- `"deck_generated"` — a deck is generated by Maestro/Builder.
- `"signature_sent"` — a signature/envelope is sent via the signing flow.
- `"ai_call"` — a notable Maestro/AI call (e.g. generation/redline/Q&A).
- `"storage_bytes_delta"` — change in stored bytes (uploads/imports).
- `"connector_sync"` — a connector sync job runs (Drive, Gmail, etc.).

These are deliberately broad; PG-W23 will refine them into billing-grade
dimensions and caps.

---

## 3. Logging API (`lib/metering.ts`)

Server-only helper:

```ts
type UsageEventType =
  | "doc_created"
  | "doc_saved"
  | "contract_generated"
  | "deck_generated"
  | "signature_sent"
  | "ai_call"
  | "storage_bytes_delta"
  | "connector_sync";

interface UsageEventInput {
  orgId: string;
  userId?: string | null;
  eventType: UsageEventType;
  amount?: number; // default: 1
  metadata?: Record<string, unknown>;
}

declare function logUsageEvent(input: UsageEventInput): Promise<void>;
```

Implementation notes:

- Uses a Supabase **service role** client under the hood (server-side only).
- Inserts one row into `metering_events` with the provided fields.
- Swallows errors (logs to `console.warn`) so metering failures never break
  user-facing flows.

Typical usage (server action / route handler):

```ts
await logUsageEvent({
  orgId,
  userId,
  eventType: "doc_created",
  amount: 1,
  metadata: { source: "builder", docType: "contract" },
});
```

---

## 4. `/admin/metrics` internal view

File: `app/(protected)/admin/metrics/page.tsx`

- Calls `getUsageSummaryLast7Days()` from `lib/metering.ts`.
- Aggregates events for the last 7 days by `(org_id, event_type)`.
- Displays a simple read-only table:
  - Org ID
  - Event type
  - Total amount
  - Event count
  - Timestamp of last event

This page is for **internal use only** (debugging and sanity checks). It is
not a customer-facing analytics page.

---

## 5. Next steps

- Wire `logUsageEvent` into a few key flows:
  - Doc created/saved to Vault.
  - Contract/deck generation.
  - Signature send.
  - Connector sync jobs (once Jobs/Queue is fully wired).
- Add per-org usage views into Insights (PG-W9) and plan enforcement
  (PG-W23) using the same `metering_events` data.

